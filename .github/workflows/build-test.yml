name: Test Build

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Inject OAuth credentials (if available)
        env:
          BUILD_GMAIL_CLIENT_ID: ${{ secrets.BUILD_GMAIL_CLIENT_ID }}
          BUILD_GMAIL_CLIENT_SECRET: ${{ secrets.BUILD_GMAIL_CLIENT_SECRET }}
        run: |
          if [ -n "$BUILD_GMAIL_CLIENT_ID" ] && [ -n "$BUILD_GMAIL_CLIENT_SECRET" ]; then
            python3 scripts/inject-credentials.py
            echo "✓ Credentials injected"
          else
            echo "⚠ Credentials not available, using placeholder values"
          fi

      - name: Build distribution
        run: uv build

      - name: Verify build artifacts
        run: |
          ls -lh dist/
          echo ""
          echo "Build artifacts:"
          for file in dist/*; do
            echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
          done

      - name: Test install from wheel
        run: |
          # Test that the wheel can be installed
          uv pip install dist/*.whl --force-reinstall
          gmail-unsub --help || true

      - name: Revert credential changes
        if: always()
        run: |
          git checkout src/gmail_ai_unsub/gmail/auth.py || true
